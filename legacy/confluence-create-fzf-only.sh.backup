#!/usr/bin/env bash
#
# confluence-create.sh - Interactive Confluence page creator with fzf
#
# Usage:
#   ./confluence-create.sh [--profile PROFILE] [--template TEMPLATE]
#
# Features:
#   - Select space interactively with fzf
#   - Optionally select parent page for hierarchy
#   - Enter page title
#   - Edit content in your preferred editor
#   - Automatically creates the page
#

set -euo pipefail

# Configuration
PROFILE="${CONFLUENCE_PROFILE:-localhost}"
TEMPLATE=""
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --profile)
            PROFILE="$2"
            shift 2
            ;;
        --template)
            TEMPLATE="$2"
            shift 2
            ;;
        --help|-h)
            cat << EOF
Usage: $0 [OPTIONS]

Interactive Confluence page creator with fzf selection.

OPTIONS:
    --profile PROFILE   Config profile to use (default: localhost)
    --template FILE     Use markdown template file
    --help, -h          Show this help message

WORKFLOW:
    1. Select space with fzf
    2. Optionally select parent page
    3. Enter page title
    4. Edit content in your editor
    5. Page is created automatically

EXAMPLES:
    # Basic usage
    $0

    # Use work profile
    $0 --profile work

    # Start with template
    $0 --template templates/meeting-notes.md

EOF
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Load config
CONFIG_FILE="$HOME/.config/confluence-markdown/config.json"

if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}Error: Config file not found at $CONFIG_FILE${NC}"
    echo "Create one with: uv run confluence-markdown --init-config"
    exit 1
fi

# Extract config values
read -r BASE_URL USERNAME PASSWORD < <(python3 -c "
import json
import sys

try:
    with open('$CONFIG_FILE') as f:
        config = json.load(f)

    if '$PROFILE' not in config:
        print('', file=sys.stderr)
        print(f'Profile \"$PROFILE\" not found in config', file=sys.stderr)
        sys.exit(1)

    profile = config['$PROFILE']
    base_url = profile.get('base_url', '')
    username = profile.get('username', '')
    password = profile.get('password', profile.get('token', ''))

    print(f'{base_url} {username} {password}')
except Exception as e:
    print('', file=sys.stderr)
    print(f'Error loading config: {e}', file=sys.stderr)
    sys.exit(1)
")

if [[ -z "$BASE_URL" ]]; then
    echo -e "${RED}Error: Could not load profile '$PROFILE' from config${NC}"
    exit 1
fi

echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}${CYAN}  Confluence Page Creator${NC}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Step 1: Select Space
echo -e "${BLUE}Step 1: Select Space${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo "Fetching spaces from $BASE_URL..."

SPACES_JSON=$(curl -s -u "$USERNAME:$PASSWORD" \
    "$BASE_URL/rest/api/space?limit=100" 2>/dev/null)

if [[ -z "$SPACES_JSON" ]]; then
    echo -e "${RED}Error: Failed to fetch spaces from Confluence${NC}"
    exit 1
fi

# Parse spaces for fzf
SPACES_LIST=$(echo "$SPACES_JSON" | python3 -c "
import json
import sys

try:
    data = json.load(sys.stdin)
    results = data.get('results', [])

    if not results:
        print('No spaces found', file=sys.stderr)
        sys.exit(1)

    for space in results:
        key = space.get('key', 'UNKNOWN')
        name = space.get('name', 'Unknown Space')
        space_type = space.get('type', 'unknown')

        # Format: KEY | Name | Type
        print(f'{key:15} | {name:50} | {space_type}')
except Exception as e:
    print(f'Error parsing JSON: {e}', file=sys.stderr)
    sys.exit(1)
")

if [[ -z "$SPACES_LIST" ]]; then
    echo -e "${RED}Error: No spaces found${NC}"
    exit 1
fi

SPACE_COUNT=$(echo "$SPACES_LIST" | wc -l | tr -d ' ')
echo -e "${GREEN}Found $SPACE_COUNT spaces${NC}"
echo ""

# Select space with fzf
SELECTED_SPACE=$(echo "$SPACES_LIST" | fzf \
    --height=40% \
    --border=rounded \
    --prompt="Select space > " \
    --header="Key | Name | Type" \
    --preview="echo {}" \
    --preview-window=up:3:wrap \
    --color="header:italic:underline")

if [[ -z "$SELECTED_SPACE" ]]; then
    echo -e "${YELLOW}No space selected. Aborting.${NC}"
    exit 0
fi

SPACE_KEY=$(echo "$SELECTED_SPACE" | awk -F'|' '{print $1}' | tr -d ' ')
SPACE_NAME=$(echo "$SELECTED_SPACE" | awk -F'|' '{print $2}' | sed 's/^[ \t]*//;s/[ \t]*$//')

echo -e "${GREEN}✓${NC} Selected space: ${BOLD}$SPACE_KEY${NC} ($SPACE_NAME)"
echo ""

# Step 2: Select Parent Page (Optional)
echo -e "${BLUE}Step 2: Select Parent Page (Optional)${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo "Fetching pages in space $SPACE_KEY..."

PAGES_JSON=$(curl -s -u "$USERNAME:$PASSWORD" \
    "$BASE_URL/rest/api/content?type=page&spaceKey=$SPACE_KEY&limit=1000" 2>/dev/null)

PAGES_LIST=$(echo "$PAGES_JSON" | python3 -c "
import json
import sys

try:
    data = json.load(sys.stdin)
    results = data.get('results', [])

    if not results:
        print('No pages in this space', file=sys.stderr)
        sys.exit(1)

    for page in results:
        page_id = page.get('id', '')
        title = page.get('title', 'Untitled')

        # Format: Title | PageID
        print(f'{title:70} | {page_id}')
except Exception as e:
    print(f'Error: {e}', file=sys.stderr)
    sys.exit(1)
" 2>/dev/null || echo "")

PARENT_ID=""

if [[ -n "$PAGES_LIST" ]]; then
    PAGE_COUNT=$(echo "$PAGES_LIST" | wc -l | tr -d ' ')
    echo -e "${GREEN}Found $PAGE_COUNT pages${NC}"
    echo -e "${YELLOW}Select a parent page, or press ESC to create at root level${NC}"
    echo ""

    # Add "No parent" option at the top
    PAGES_WITH_NONE=$(echo -e "[ No Parent - Create at root level ]                                 | NONE\n$PAGES_LIST")

    SELECTED_PARENT=$(echo "$PAGES_WITH_NONE" | fzf \
        --height=40% \
        --border=rounded \
        --prompt="Select parent (ESC for none) > " \
        --header="Title | Page ID" \
        --preview="echo {}" \
        --preview-window=up:3:wrap \
        --color="header:italic:underline" || echo "")

    if [[ -n "$SELECTED_PARENT" ]]; then
        PARENT_ID=$(echo "$SELECTED_PARENT" | awk -F'|' '{print $NF}' | tr -d ' ')
        if [[ "$PARENT_ID" == "NONE" ]]; then
            PARENT_ID=""
            echo -e "${GREEN}✓${NC} Creating page at root level"
        else
            PARENT_TITLE=$(echo "$SELECTED_PARENT" | awk -F'|' '{print $1}' | sed 's/^[ \t]*//;s/[ \t]*$//')
            echo -e "${GREEN}✓${NC} Parent page: ${BOLD}$PARENT_TITLE${NC} (ID: $PARENT_ID)"
        fi
    else
        echo -e "${GREEN}✓${NC} No parent selected - creating at root level"
    fi
else
    echo -e "${YELLOW}No pages in this space yet - creating at root level${NC}"
fi

echo ""

# Step 3: Enter Title
echo -e "${BLUE}Step 3: Enter Page Title${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

read -p "Enter page title: " PAGE_TITLE

if [[ -z "$PAGE_TITLE" ]]; then
    echo -e "${RED}Error: Page title cannot be empty${NC}"
    exit 1
fi

echo -e "${GREEN}✓${NC} Title: ${BOLD}$PAGE_TITLE${NC}"
echo ""

# Step 4: Edit Content
echo -e "${BLUE}Step 4: Create Content${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Create temp file for content
TEMP_FILE=$(mktemp /tmp/confluence-create-XXXXXX.md)

# Use template if provided
if [[ -n "$TEMPLATE" && -f "$TEMPLATE" ]]; then
    cat "$TEMPLATE" > "$TEMP_FILE"
    echo -e "${GREEN}✓${NC} Loaded template from: $TEMPLATE"
else
    # Default template
    cat > "$TEMP_FILE" << EOF
# $PAGE_TITLE

## Overview

Write your page content here using Markdown.

## Sections

### Section 1

Content goes here...

### Section 2

More content...

## Tips

- Use **bold** for emphasis
- Use *italic* for subtle emphasis
- Use tables, lists, and code blocks
- Delete this template content and write your own!

EOF
fi

# Detect editor
EDITOR="${EDITOR:-}"
if [[ -z "$EDITOR" ]]; then
    for ed in code vim nano emacs gedit; do
        if command -v "$ed" &> /dev/null; then
            EDITOR="$ed"
            break
        fi
    done
fi

if [[ -z "$EDITOR" ]]; then
    EDITOR="vi"  # fallback
fi

echo "Opening editor: $EDITOR"
echo "Edit your content, save, and close the editor to continue..."
echo ""

# Get original modification time
ORIGINAL_MTIME=$(stat -f %m "$TEMP_FILE" 2>/dev/null || stat -c %Y "$TEMP_FILE" 2>/dev/null)

# Open editor
$EDITOR "$TEMP_FILE"

# Check if file was modified
NEW_MTIME=$(stat -f %m "$TEMP_FILE" 2>/dev/null || stat -c %Y "$TEMP_FILE" 2>/dev/null)

if [[ "$NEW_MTIME" == "$ORIGINAL_MTIME" ]]; then
    echo -e "${YELLOW}No changes made. Aborting.${NC}"
    rm -f "$TEMP_FILE"
    exit 0
fi

# Read content
CONTENT=$(cat "$TEMP_FILE")
rm -f "$TEMP_FILE"

echo -e "${GREEN}✓${NC} Content ready ($(echo "$CONTENT" | wc -l) lines)"
echo ""

# Step 5: Create Page
echo -e "${BLUE}Step 5: Creating Page${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Build command
CMD_ARGS=(
    "uv" "run" "confluence-markdown"
    "--config"
    "--profile" "$PROFILE"
    "--action" "create"
    "--space" "$SPACE_KEY"
    --title "$PAGE_TITLE"
    "--content" "$CONTENT"
)

# Add parent ID if specified
if [[ -n "$PARENT_ID" ]]; then
    CMD_ARGS+=("--parent-id" "$PARENT_ID")
fi

# Execute
echo "Creating page..."
"${CMD_ARGS[@]}" 2>&1 | grep -v "^DEBUG:" | grep -v "warning:"

echo ""
echo -e "${BOLD}${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}${GREEN}  Page created successfully!${NC}"
echo -e "${BOLD}${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
